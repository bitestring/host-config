- name: Play for creating container toolboxes using Distrobox or Toolbox
  hosts: localhost
  become: false

  vars:
    username: "{{ ansible_user_id }}"

  tasks:
    - name: Echo init message
      ansible.builtin.debug:
        msg: Playing create-toolbox.yml as user {{ username }}

    - name: Create general development container with Distrobox
      ansible.builtin.shell: distrobox assemble create --file ./distrobox-manifests/generic.ini

    - name: Create gnunet development container with Distrobox
      ansible.builtin.shell: distrobox assemble create --file ./distrobox-manifests/gnunet.ini

    - name: Create podman-host executable to interact with Podman from inside Flatpak apps
      ansible.builtin.copy:
        dest: ~/.local/bin/podman-host
        content: |
          #!/bin/bash
          set -x
          if [ "$1" == "exec" ]; then
           # Remove 'exec' from $@
           shift
           script='
               result_command="podman exec"
                  for i in $(printenv | grep "=" | grep -Ev " |\"" |
                      grep -Ev "^(HOST|HOSTNAME|HOME|PATH|SHELL|USER|_)"); do

                      result_command=$result_command --env="$i"
               done

                  exec ${result_command} "$@"
              '
           exec flatpak-spawn --host sh -c "$script" - "$@"
          else
           exec flatpak-spawn --host podman "$@"
          fi
        mode: u=rx,g=r,o=r
